# Fur-Img-API_V3

ä¸€ä¸ªåŸºäº Node.js å’Œ Express çš„é«˜æ€§èƒ½å›¾ç‰‡/æ–‡ä»¶æœåŠ¡ APIï¼Œæä¾›ç›®å½•æ‰«æã€æ•°æ®åº“å­˜å‚¨ã€éšæœºæ–‡ä»¶æå–å’Œå®Œæ•´æ–‡ä»¶å¤–æ”¾åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“ **è‡ªåŠ¨ç›®å½•æ‰«æ** - é€’å½’æ‰«æé…ç½®ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
- ğŸ² **éšæœºæ–‡ä»¶æå–** - ä»å…¨éƒ¨æ–‡ä»¶æˆ–æŒ‡å®šç›®å½•ä¸­è·å–éšæœºæ–‡ä»¶
- ğŸ“Š **SQLite æ•°æ®åº“** - é«˜æ•ˆçš„æ–‡ä»¶ç´¢å¼•å’ŒæŸ¥è¯¢
- ğŸ” **è®¤è¯ä¸æˆæƒ** - æ”¯æŒç®¡ç†å‘˜ Token éªŒè¯
- ğŸš¦ **é€Ÿç‡é™åˆ¶** - å†…ç½®é€Ÿç‡é™åˆ¶é˜²æ­¢æ»¥ç”¨
- ğŸŒ **CORS è·¨åŸŸ** - çµæ´»çš„è·¨åŸŸèµ„æºå…±äº«é…ç½®
- ğŸ“¦ **Gzip å‹ç¼©** - è‡ªåŠ¨å“åº”å‹ç¼©å‡å°‘å¸¦å®½
- ğŸ¥ **å¥åº·æ£€æŸ¥** - å®æ—¶ç›‘æ§æœåŠ¡å™¨çŠ¶æ€å’Œèµ„æºä½¿ç”¨
- ğŸ“ **æ—¥å¿—ç³»ç»Ÿ** - Pino é«˜æ€§èƒ½æ—¥å¿—ï¼Œè‡ªåŠ¨æ—¥å¿—è½®æ¢ï¼Œæ”¯æŒæ§åˆ¶å°å’Œæ–‡ä»¶è¾“å‡º
- ğŸ”— **é™æ€æ–‡ä»¶æœåŠ¡** - ç›´æ¥æä¾›å›¾ç‰‡å’Œæ–‡ä»¶ä¸‹è½½

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
npm install
```

é¡¹ç›®å·²é¢„è£…ä»¥ä¸‹å…³é”®ä¾èµ–ï¼š
- `express` - Web æ¡†æ¶
- `better-sqlite3` - SQLite3 æ•°æ®åº“
- `pino` - é«˜æ€§èƒ½æ—¥å¿—åº“
- `pino-http` - HTTP è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
- `pino-pretty` - æ—¥å¿—æ ¼å¼åŒ–
- `cors` - CORS ä¸­é—´ä»¶
- `express-rate-limit` - é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
- `rate-limit-sqlite` - SQLite æŒä¹…åŒ–é€Ÿç‡é™åˆ¶å­˜å‚¨
- `compression` - Gzip å‹ç¼©
- `dayjs` - æ—¥æœŸæ—¶é—´å¤„ç†
- `fs-extra` - å¢å¼ºæ–‡ä»¶ç³»ç»Ÿæ“ä½œ
- `chalk` - ç»ˆç«¯å½©è‰²è¾“å‡º
- `node-cron` - å®šæ—¶ä»»åŠ¡ï¼ˆé¢„ç•™ï¼‰

### é…ç½®

ç¼–è¾‘ `config/config.json` é…ç½®æ–‡ä»¶ï¼š

```json
{
  "server": {
    "addr": "localhost",            // ç›‘å¬åœ°å€
    "httpport": 3000,               // HTTP ç«¯å£
    "httpsport": 3001,              // HTTPS ç«¯å£
    "forcehttps": false,            // æ˜¯å¦å¼ºåˆ¶ HTTPSï¼Œæš‚æœªå¼€å‘
    "gzip": false,                  // æ˜¯å¦å¯ç”¨ Gzip å‹ç¼©
    "ssl": {
      "enable": false,              // æ˜¯å¦å¯ç”¨ SSL
      "cert": "./ssl/fullchain.pem", // SSL è¯ä¹¦è·¯å¾„
      "key": "./ssl/privkey.pem"    // SSL å¯†é’¥è·¯å¾„
    },
    "cors": {
      "enabled": true,              // å¯ç”¨ CORS
      "origins": "*",               // å…è®¸çš„æº
      "methods": "GET, POST, PUT, DELETE, OPTIONS",
      "preflightContinue": false,
      "optionsSuccessStatus": 204
    },
    "rateLimit": {
      "enable": true,               // å¯ç”¨é€Ÿç‡é™åˆ¶
      "windowMS": 15,               // æ—¶é—´çª—å£ï¼ˆåˆ†é’Ÿï¼‰
      "limit": 100,                 // é™åˆ¶è¯·æ±‚æ•°
      "statusCode": 429,            // è¶…é™æ—¶è¿”å›çš„çŠ¶æ€ç 
      "message": "too many requests", // è¶…é™æ—¶çš„é”™è¯¯æ¶ˆæ¯
      "standardHeaders": "draft-8",
      "legacyHeaders": false,
      "validate": {
        "trustProxy": false
      }
    }
  },
  "db": {
    "sqlite3": {
      "file": "./data/app.db"       // æ•°æ®åº“æ–‡ä»¶è·¯å¾„
    }
  },
  "log": {
    "path": "./logs",               // æ—¥å¿—ç›®å½•
    "level": 4,                     // æ—¥å¿—çº§åˆ«ï¼ˆ0=silent, 1=fatal, 2=error, 3=warn, 4=info, 5=debug, 6=traceï¼‰
    "console": true,                // æ˜¯å¦è¾“å‡ºåˆ°æ§åˆ¶å°
    "file": true,                   // æ˜¯å¦è¾“å‡ºåˆ°æ–‡ä»¶
    "maxFiles": 7,                   // ä¿ç•™çš„æœ€å¤§æ—¥å¿—æ–‡ä»¶æ•°
    "maxSize": 1                    //ä¿ç•™çš„æœ€å¤§æ—¥å¿—ï¼Œå•ä½æ˜¯MB
  },
  "paths": {
    "html": "./public",             // é™æ€ç½‘ç«™æ–‡ä»¶ç›®å½•
    "images": "./tupian"            // å›¾ç‰‡/æ–‡ä»¶ç›®å½•
  },
  "admintoken": "114514"            // ç®¡ç†å‘˜ Token
}
```

> âš ï¸ **é‡è¦æç¤ºï¼šå›¾ç‰‡æ–‡ä»¶å¤¹ç›®å½•å‘½åè§„èŒƒ**
> 
> é…ç½®ä¸­ `paths.images` æŒ‡å‘çš„ç›®å½•åŠå…¶**æ‰€æœ‰å­ç›®å½•åç§°**ä¸å¯åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
> - **ä¸­æ–‡å­—ç¬¦** - å¯èƒ½å¯¼è‡´è·¯ç”±è¯†åˆ«å¤±è´¥
> - **ç‰¹æ®ŠURLç¬¦å·** - `? # & = % : @ ; , [ ] { } ( ) < > \ " ' ` | * + ç©ºæ ¼`
> 
> **å»ºè®®ï¼š** ä»…ä½¿ç”¨ **è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ `_` å’Œè¿å­—ç¬¦ `-`**
> 
> **é”™è¯¯ç¤ºä¾‹ï¼š** âŒ `./img/æ‘„å½±ä½œå“/2024å¹´` `./img/photo?test` `./img/my files`
> 
> **æ­£ç¡®ç¤ºä¾‹ï¼š** âœ… `./img/photography/2024` `./img/photo_test` `./img/my-files`
```

### å¯åŠ¨æœåŠ¡

**æœ¬åœ°å¼€å‘ï¼š**
```bash
npm start
```

æœåŠ¡å°†åœ¨ `http://localhost:3000` å¯åŠ¨ã€‚

### Docker éƒ¨ç½²

#### æ‹‰å–é•œåƒ

```bash
docker pull fasfuah/fur-img-api_v3
```

#### è¿è¡Œå®¹å™¨

```bash
docker run -d \
  --name fur-img-api \
  -p 3000:3000 \
  -v /path/to/img:/app/img \
  -v /path/to/ssl:/app/ssl \
  -v /path/to/public:/app/public \
  -v /path/to/data:/app/data \
  fasfuah/fur-img-api_v3
```

**å‚æ•°è¯´æ˜ï¼š**
- `-d` - åå°è¿è¡Œå®¹å™¨
- `--name fur-img-api` - å®¹å™¨åç§°
- `-p 3000:3000` - ç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœº:å®¹å™¨ï¼‰
- `-v /path/to/img:/app/img` - å›¾ç‰‡ç›®å½•æŒä¹…åŒ–å·
- `-v /path/to/ssl:/app/ssl` - SSLè¯ä¹¦ç›®å½•æŒä¹…åŒ–å·
- `-v /path/to/public:/app/public` - å…¬å…±æ–‡ä»¶ç›®å½•æŒä¹…åŒ–å·
- `-v /path/to/data:/app/data` - æŒ‚è½½dataç›®å½•

**å®¹å™¨è®¿é—®ï¼š**
```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs -f fur-img-api

# åœæ­¢å®¹å™¨
docker stop fur-img-api

# é‡å¯å®¹å™¨
docker restart fur-img-api

# åˆ é™¤å®¹å™¨
docker rm fur-img-api
```

## API ç«¯ç‚¹

### 1. è·å–éšæœºæ–‡ä»¶

**è¯·æ±‚ï¼š**
```http
GET /api
```

**æŸ¥è¯¢å‚æ•°ï¼š**
- `json=true` (å¯é€‰) - è¿”å› JSON æ ¼å¼çš„æ–‡ä»¶ä¿¡æ¯è€Œéæ–‡ä»¶æœ¬èº«

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "file": "photo.jpg",
  "path": "/path/to/dir",
  "size": 2048576,
  "url": "http://localhost:3000/files/photo.jpg"
}
```

---

### 2. ä»æŒ‡å®šç›®å½•è·å–éšæœºæ–‡ä»¶

**è¯·æ±‚ï¼š**
```http
GET /api/folderpath
GET /api/folderpath/subfolder
```
 
**ç¤ºä¾‹ï¼š**
```http
GET /api/2024/january?json=true
```

**æŸ¥è¯¢å‚æ•°ï¼š**
- `json=true` (å¯é€‰) - è¿”å› JSON æ ¼å¼çš„æ–‡ä»¶ä¿¡æ¯

**å“åº”è¯´æ˜ï¼š** è¿”å›æŒ‡å®šæ–‡ä»¶å¤¹ä¸­çš„éšæœºæ–‡ä»¶ï¼Œæ ¼å¼åŒ `/api` ç«¯ç‚¹ã€‚
 
---

### 3. è·å–å®Œæ•´æ–‡ä»¶åˆ—è¡¨

**è¯·æ±‚ï¼š**
```http
GET /filelist
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "photos/2024": {
    "photo1.jpg": "/files/photos/2024/photo1.jpg",
    "photo2.jpg": "/files/photos/2024/photo2.jpg"
  }
}
```

---

### 4. æœåŠ¡å™¨å¥åº·æ£€æŸ¥

**è¯·æ±‚ï¼š**
```http
GET /health
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "ok",
  "memory": {
    "rss": "150.25 MB",
    "heapTotal": "200.40 MB",
    "heapUsed": "120.15 MB",
    "external": "5.20 MB"
  },
  "platform": "win32",
  "arch": "x64",
  "nodeVersion": "v20.0.0",
  "uptime": {
    "ms": 3600000,
    "formatted": "0å¤© 1æ—¶ 0åˆ† 0ç§’"
  },
  "timestamp": "2024-01-15 10:30:45"
}
```

---

### 5. åˆ·æ–°æ•°æ®åº“ï¼ˆç®¡ç†å‘˜ï¼‰

**è¯·æ±‚ï¼š**
```http
POST /admin/refresh?token=114514
```

**æŸ¥è¯¢å‚æ•°ï¼š**
- `token` - ç®¡ç†å‘˜ Token

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "message": "refresh database start"
}
```

**è¯´æ˜ï¼š** é‡æ–°æ‰«æé…ç½®ç›®å½•ï¼Œæ›´æ–°æ•°æ®åº“ä¸­çš„æ–‡ä»¶ç´¢å¼•ã€‚

---

### 6. è§£å°å•ä¸ª IPï¼ˆç®¡ç†å‘˜ï¼‰

**è¯·æ±‚ï¼š**
```http
POST /admin/unban/:ip?token=114514
```

**è·¯å¾„å‚æ•°ï¼š**
- `:ip` - éœ€è¦è§£å°çš„ IP åœ°å€

**æŸ¥è¯¢å‚æ•°ï¼š**
- `token` - ç®¡ç†å‘˜ Token

**æˆåŠŸå“åº”ç¤ºä¾‹ï¼ˆ200ï¼‰ï¼š**
```json
{
  "message": "Successfully unbanned 192.168.1.100"
}
```

**é”™è¯¯å“åº”ç¤ºä¾‹ï¼ˆ404ï¼‰ï¼š**
```json
{
  "error": "IP not found in banlist"
}
```

**è¯´æ˜ï¼š** ä»é€Ÿç‡é™åˆ¶é»‘åå•ä¸­ç§»é™¤æŒ‡å®šçš„ IP åœ°å€ã€‚

---

### 7. è·å–è¢«ç¦ç”¨ IP åˆ—è¡¨

**è¯·æ±‚ï¼š**
```http
GET /banlist
```

**å“åº”ç¤ºä¾‹ï¼ˆæœ‰è¢«ç¦ç”¨çš„ IPï¼‰ï¼š**
```json
{
  "ip": "192.168.1.100",
  "totalHits": 150,
  "resetTime": "2024-01-15T11:30:45.000Z"
}
```

**å“åº”ç¤ºä¾‹ï¼ˆæ— è¢«ç¦ç”¨çš„ IPï¼‰ï¼š**
```json
{
  "message": "no banned IPs"
}
```

**è¯´æ˜ï¼š** è¿”å›æ‰€æœ‰è¢«é€Ÿç‡é™åˆ¶è§¦å‘ç¦ç”¨çš„ IP åœ°å€å’Œç›¸å…³ä¿¡æ¯ã€‚

---

### 8. ç›´æ¥ä¸‹è½½æ–‡ä»¶

**è¯·æ±‚ï¼š**
```http
GET /files/path/to/file.jpg
```

**è¯´æ˜ï¼š** é…ç½® `paths.images` ç›®å½•ä¸­çš„æ–‡ä»¶éƒ½å¯é€šè¿‡è¯¥è·¯å¾„ç›´æ¥è®¿é—®ã€‚

## æ—¥å¿—ç³»ç»Ÿ

é¡¹ç›®ä½¿ç”¨ **Pino** é«˜æ€§èƒ½æ—¥å¿—åº“ï¼Œæä¾›ï¼š

- **è‡ªåŠ¨æ—¥å¿—è½®æ¢** - æŒ‰æ—¥æœŸè‡ªåŠ¨ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ï¼ˆformat: `app-YYYY-MM-DD.log`ï¼‰
- **å¤šè¾“å‡º** - åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆå½©è‰²æ ¼å¼ï¼‰å’Œæ–‡ä»¶ï¼ˆçº¯æ–‡æœ¬æ ¼å¼ï¼‰
- **ç»“æ„åŒ–æ—¥å¿—** - è‡ªåŠ¨æ•è·é”™è¯¯å †æ ˆä¿¡æ¯
- **æ—¥å¿—çº§åˆ«** - æ”¯æŒ 0(silent) åˆ° 6(trace) å…± 7 ä¸ªçº§åˆ«

**æ—¥å¿—ç›®å½•ï¼š** `./logs/` é…ç½®è·¯å¾„ä¸‹çš„æ—¥å¿—æ–‡ä»¶

**é…ç½®ç¤ºä¾‹ï¼š**
```json
"log": {
  "path": "./logs",     // æ—¥å¿—å­˜å‚¨ç›®å½•
  "level": 4,           // æ—¥å¿—çº§åˆ«ï¼š4=info
  "console": true,      // æ˜¯å¦åœ¨æ§åˆ¶å°æ‰“å°
  "file": true,         // æ˜¯å¦ä¿å­˜åˆ°æ–‡ä»¶
  "maxFiles": 7,         // ä¿ç•™æœ€è¿‘ 7 å¤©çš„æ—¥å¿—
  "maxSize": 1          //ä¿ç•™æœ€å¤§1MBçš„æ—¥å¿—
}
```

### è¯·æ±‚æ—¥å¿—

æ‰€æœ‰ HTTP è¯·æ±‚éƒ½ä¼šè¢«è‡ªåŠ¨è®°å½•ï¼ŒåŒ…æ‹¬è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€ç å’Œå“åº”æ—¶é—´ã€‚

### é”™è¯¯å¤„ç†

æ‰€æœ‰å¼‚å¸¸å’Œé”™è¯¯éƒ½ä¼šè¢«è‡ªåŠ¨æ•è·å¹¶è®°å½•å®Œæ•´çš„å †æ ˆä¿¡æ¯ï¼š
- å¼‚æ­¥æ“ä½œé”™è¯¯
- æ•°æ®åº“æ“ä½œå¼‚å¸¸
- æ–‡ä»¶ç³»ç»Ÿé”™è¯¯
- å…¨å±€æœªæ•è·å¼‚å¸¸

### CORS è·¨åŸŸ

å¯åœ¨ `config/config.json` ä¸­å¯ç”¨/ç¦ç”¨ CORSï¼š
```json
"cors": {
  "enabled": true,
  "origins": "*",
  "methods": "GET, POST, PUT, DELETE, OPTIONS",
  "preflightContinue": false,
  "optionsSuccessStatus": 204
}
```

### é€Ÿç‡é™åˆ¶

é˜²æ­¢ API æ»¥ç”¨ï¼š
```json
"rateLimit": {
  "enable": true,               // å¯ç”¨é€Ÿç‡é™åˆ¶
  "windowMS": 15,               // 15åˆ†é’Ÿæ—¶é—´çª—å£
  "limit": 100,                 // æœ€å¤š100ä¸ªè¯·æ±‚
  "statusCode": 429,            // è¶…é™è¿”å›çš„çŠ¶æ€ç 
  "message": "too many requests"
}
```
è¶…é™è¿”å› 429 çŠ¶æ€ç ã€‚

### Gzip å‹ç¼©

åœ¨é…ç½®ä¸­å¯ç”¨ä»¥å‡å°‘å“åº”å¤§å°ï¼š
```json
"gzip": true
```

## é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ app.js                 # åº”ç”¨å…¥å£
â”œâ”€â”€ package.json           # é¡¹ç›®é…ç½®å’Œä¾èµ–
â”œâ”€â”€ eslint.config.mjs      # ESLint é…ç½®
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ config.json       # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ app.db            # SQLite æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ db.js         # SQLite æ•°æ®åº“æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ã€é€Ÿç‡é™åˆ¶ï¼‰
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ config.js     # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ logger.js     # Pino æ—¥å¿—å·¥å…·ï¼ˆåŒ…æ‹¬æ—¥å¿—è½®æ¢ã€æ ¼å¼åŒ–ï¼‰
â”‚   â”‚   â”œâ”€â”€ loggerInstance.js  # æ—¥å¿—å®ä¾‹å¯¼å‡º
â”‚   â”‚   â””â”€â”€ scanner.js    # ç›®å½•æ‰«æå·¥å…·ï¼ˆé€’å½’æ‰«ææ–‡ä»¶ï¼‰
â”‚   â””â”€â”€ web/
â”‚       â”œâ”€â”€ server.js     # Express æœåŠ¡å™¨å¯åŠ¨å’Œé…ç½®
â”‚       â”œâ”€â”€ middleware.js # HTTP ä¸­é—´ä»¶ï¼ˆè¯·æ±‚æ—¥å¿—ã€è®¤è¯ï¼‰
â”‚       â”œâ”€â”€ api.js        # æŒ‚è½½ API è·¯ç”±
â”‚       â””â”€â”€ router/       # è·¯ç”±æ¨¡å—ï¼ˆæ¨¡å—åŒ–æ–¹å¼ï¼‰
â”‚           â”œâ”€â”€ admin.js  # ç®¡ç†å‘˜è·¯ç”±ï¼ˆåˆ·æ–°æ•°æ®åº“ã€è§£å°IPï¼‰
â”‚           â”œâ”€â”€ status.js # çŠ¶æ€è·¯ç”±ï¼ˆå¥åº·æ£€æŸ¥ã€æ–‡ä»¶åˆ—è¡¨ã€é»‘åå•ï¼‰
â”‚           â”œâ”€â”€ randomimg.js     # éšæœºå›¾ç‰‡è·¯ç”±
â”‚           â”œâ”€â”€ staticfiles.js   # é™æ€æ–‡ä»¶è·¯ç”±
â”‚           â””â”€â”€ routermiddleware.js  # è·¯ç”±ä¸­é—´ä»¶
â”œâ”€â”€ logs/                 # æ—¥å¿—ç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚   â””â”€â”€ app-YYYY-MM-DD.log   # æ—¥å¿—æ–‡ä»¶ï¼ˆæŒ‰æ—¥æœŸï¼‰
â”œâ”€â”€ ssl/                  # SSL è¯ä¹¦ç›®å½•ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ public/               # é™æ€ç½‘ç«™æ–‡ä»¶ç›®å½•
â””â”€â”€ img/               # å›¾ç‰‡/æ–‡ä»¶è‡ªå®šä¹‰ç›®å½•ï¼ˆå¯é…ç½®ï¼‰
```

## å¼€å‘å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
npm start

# ä»£ç è´¨é‡æ£€æŸ¥
npm run lint

# è‡ªåŠ¨ä¿®å¤ä»£ç é£æ ¼
npm run lint:fix
```

## License

GPL-3.0-only